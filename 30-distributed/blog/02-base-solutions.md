
* 主备-复制
* 最终一致性方案

### 主备-复制
事实上，最终一致性并不是只有那些大型分布式系统才涉及的特性，许多现代的关系型数据库都采用了最终一致性模型。在现代关系型数据库中（比如MySQL和PostgreSQL），大多都会采用同步或异步方式来实现主备数据复制技术。在同步方式中，数据的复制过程通常是更新事务的一部分，因此在事务完成后，主备数据库的数据就会达到一致。而在异步方式中，备库的更新往往会存在延时，这取决于事务日志在主备数据库之间传输的时间长短。如果传输时间过长或者甚至在日志传输过程中出现异常导致无法及时将事务应用到备库上，那么很显然，从备库中读取的数据将是旧的，因此就出现了数据不一致的情况。当然，无论是采用多次重试还是人为数据订正，关系型数据库还是能够保证最终数据达到一致，这就是系统提供最终一致性保证的经典案例。

### 最终一致性方案

[系统分布式情况下最终一致性方案梳理](https://blog.csdn.net/lsx991947534/article/details/54598587 "title") 

ACID, CAP, BASE
分布式系统中，P已确定，牺牲可用性不能容忍，只能牺牲C

强一致、弱一致、最终一致性
在工程实践上，为了保障系统的可用性，互联网系统大多将强一致性需求转换成最终一致性的需求，并通过系统执行幂等性的保证，保证数据的最终一致性。

![altText](./img/eventual.consistency.method.png "title") 

#### A 业务系统业务逻辑的commit/rollback机制; 单数据库-利用数据库事务特性

#### B 异步回调机制的引入

#### C 基于事务型消息队列的最终一致性

#### C3,E4 业务应用系统的幂等性控制

* 查询
* MVCC方案 多版本并发控制，update with condition，更新带条件，乐观锁
* 单独的去重表
* 分布式锁
* 删除数据
* 插入数据的唯一索引 数据库表-联合唯一索引
* API层面的幂等
* 状态机幂等

#### E 基于消息队列+定时补偿机制的最终一致性

#### D 类似double check机制的确认机制


[保证分布式系统数据一致性的6种方案](https://blog.csdn.net/hxpjava1/article/details/79409459 "title") 

#### 1. 规避分布式事务——业务整合
业务整合方案主要采用将接口整合到本地执行的方法。


#### 2. 经典方案 - eBay 模式，通过消息日志的方式来异步执行

将需要分布式处理的任务通过消息日志的方式来异步执行。消息日志可以存储到本地文本、数据库或消息队列，再通过业务规则自动或人工发起重试。人工重试更多的是应用于支付场景，通过对账系统对事后问题的处理。

消息日志方案的核心是保证服务接口的幂等性。

考虑到网络通讯失败、数据丢包等原因，如果接口不能保证幂等性，数据的唯一性将很难保证。


#### 3. 去哪儿网分布式事务方案

随着业务规模不断地扩大，电商网站一般都要面临拆分之路。就是将原来一个单体应用拆分成多个不同职责的子系统。

新的问题-分布式事务-两种解决方式

1. 优先使用异步消息。
异步消息 Consumer 端需要实现幂等。

幂等有两种方式，一种方式是业务逻辑保证幂等。比如接到支付成功的消息订单状态变成支付完成，如果当前状态是支付完成，则再收到一个支付成功的消息则说明消息重复了，直接作为消息成功处理。

另外一种方式如果业务逻辑无法保证幂等，则要增加一个去重表或者类似的实现。对于 producer 端在业务数据库的同实例上放一个消息库，发消息和业务操作在同一个本地事务里。发消息的时候消息并不立即发出，而是向消息库插入一条消息记录，然后在事务提交的时候再异步将消息发出，发送消息如果成功则将消息库里的消息删除，如果遇到消息队列服务异常或网络问题，消息没有成功发出那么消息就留在这里了，会有另外一个服务不断地将这些消息扫出重新发送。

2. 有的业务不适合异步消息的方式，事务的各个参与方都需要同步的得到结果。这种情况的实现方式其实和上面类似，每个参与方的本地业务库的同实例上面放一个事务记录库。

总结起来，其实两种方式的根本原理是类似的，也就是将分布式事务转换为多个本地事务，然后依靠重试等方式达到最终一致性。

#### 4. 蘑菇街交易创建过程中的分布式一致性方案

在交易创建流程中，首先创建一个不可见订单，然后在同步调用锁券和扣减库存时，针对调用异常（失败或者超时），发出废单消息到MQ。如果消息发送失败，本地会做时间阶梯式的异步重试；优惠券系统和库存系统收到消息后，会进行判断是否需要做业务回滚，这样就准实时地保证了多个本地事务的最终一致性。


#### 5. 支付宝及蚂蚁金融云的分布式服务 DTS 方案

分布式事务服务 (Distributed Transaction Service, DTS) 是一个分布式事务框架，用来保障在大规模分布式环境下事务的最终一致性。DTS 从架构上分为 xts-client 和 xts-server 两部分，前者是一个嵌入客户端应用的 JAR 包，主要负责事务数据的写入和处理；后者是一个独立的系统，主要负责异常事务的恢复。


#### 6. 农信网数据一致性方案
同步服务调用，异步消息通知机制


分布式服务对衍生的配套系统要求比较多，特别是我们基于消息、日志的最终一致性方案，需要考虑消息的积压、消费情况、监控、报警等。
