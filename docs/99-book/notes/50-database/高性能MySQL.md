《高性能MySQL》宁海元等译

* 一、架构、基准测试、性能剖析
* 二、数据类型、索引、查询性能优化；库表结构优化、索引优化、查询优化需要齐头并进；应用层优化
* 三、高级特性、服务器设置、操作系统和硬件优化
* 四、复制、扩展、高可用
* 五、云端、应用层优化、备份与恢复

## 第1章 MySQL架构与历史
### 1.1 MySQL逻辑架构
* 连接处理 授权认证、安全
* 查询缓存、解析器、优化器
* 存储引擎

![MySQL逻辑架构](/99-book/img/mysql-logic-architect.png)
#### 1.1.1 连接管理与安全性
#### 1.1.2 优化与缓存
### 1.2 并发控制
### 1.2.1 读写锁
### 1.2.2 锁粒度
* 表锁
* 行级锁

### 1.3 事务
事务就是一组原子性的sql查询，或者说一个独立的工作单元。
事务内的语句，要么全部执行成功，要么全部执行失败。
#### 1.3.1 隔离级别
#### 1.3.2 死锁
#### 1.3.3 事务日志
#### 1.3.4 MySQL中的事务
### 1.4 多版本并发控制
### 1.5 MySQL的存储引擎
### 1.6 MySQL时间线
### 1.7 MySQL的开发模式

## 第2章 MySqL基准测试
基准测试是针对系统设计的一种压力测试。
### 2.1 为什么需要基准测试
### 2.2 基准测试的策略
### 2.3 基准测试的方法
### 2.4 基准测试工具
### 2.5 基准测试案例

## 第3章 服务器性能剖析
### 3.1 性能优化简介
### 3.2 对应用程序进行性能剖析
### 3.3 剖析MySQL查询
### 3.4 诊断间歇性问题
### 3.5 其他剖析工具

## 第4章 Schema与数据类型优化
### 4.1 选择优化的数据类型
#### 4.1 整型类型
#### 4.2 实数类型
#### 4.3 字符串类型
#### 4.4 日期和时间类型
#### 4.5 位数据类型
#### 4.6 选择标识符
#### 4.7 特殊类型数据
### 4.2 MySQL schema设计中的陷进
### 4.3 范式和反范式
### 4.4 缓存表和汇总表
### 4.5 加快alter table操作的速度
### 4.6 总结
简单的原则
* 尽量避免过度设计
* 使用小而简单的合适数据类型
* 尽量使用相同的数据类型存储相似或相关的值
* 注意可变长字符串
* 尽量使用整型定义标识列
* 避免使用mysql已经遗弃的特性
* 小心使用enum和set。

## 第5章 创建高性能的索引
## 5.1 索引基础
### 5.1.1 索引的类型
在MySQL中，索引是在存储引擎层而不是服务器层实现的。
* B-Tree索引
* 哈希索引 基于哈希表实现。Memory引擎支持
* 空间索引 MyISAM引擎支持
* 全文索引 查找文本中的关键字，而不是直接比较索引中的值

## 5.2 索引的优点
1. 索引大大减少了服务器需要扫描的数据量
2. 索引可以帮助服务器避免排序和临时表
3. 索引可以将随机IO变为顺序IO

## 5.3 高性能索引策略
### 5.3.1 独立的列
索引列不是表达式的一部分，也不能是函数的参数

```sql
select actor_id from actor where actor + 1 = 5;
select ... from to_days(current_date) - to_days(data_col) <= 10;
```
### 5.3.2 前缀索引和索引选择性
### 5.3.3 多列索引
### 5.3.4 选择合适的索引列顺序
### 5.3.5 聚簇索引
聚集索引、聚合索引、索引组织表（oracle）
聚簇索引并不是一种单独的索引类型，而是一种数据存储方式。当表有聚簇索引时，它的数据行实际上存放在索引的叶子页中。
“聚簇”表示数据行和相邻的键值紧凑的存储在一起。因为无法同时将数据行存放在两个不同的地方（物理位置），所以一个表
只能有一个聚簇索引。

### 5.3.6 覆盖索引
通常大家会根据查询的where条件来创建合适的索引。MySQL也可以使用索引来直接获取列的数据，这样就不再需要读取数据行。
如果一个索引包含（或者说覆盖）所有需要查询的字段的值，称为覆盖索引。
### 5.3.7 使用索引扫描来做排序
### 5.3.8 压缩（前缀压缩）索引
### 5.3.9 冗余和重复索引
### 5.3.10 未使用的索引
### 5.3.11 索引和锁
## 5.4 索引案例学习
### 5.4.1 支持多种过滤条件
### 5.4.2 避免多个范围条件
### 5.4.3 优化排序
## 5.5 维护索引和表

## 第6章 查询性能优化
查询优化、索引优化、库表结构优化需要起投并进，一个不落。
### 6.1 为什么查询速度变慢
### 6.2 慢查询基础：优化数据访问
#### 6.2.1 是否想数据库请求了不需要的数据
#### 6.2.2 MySQL是否在扫描额外的记录
### 6.3 重构查询的方式
#### 6.3.1 一个复杂查询还是多个简单查询
#### 6.3.2 切分查询
#### 6.3.3 分解关联查询
### 6.4 查询执行的基础
### 6.5 MySQL查询优化器的局限性
### 6.6 查询优化器的提示
### 6.7 优化特定类型的查询
### 6.8 案例学习

## 第7章 MySQL高级特性
### 7.1 分区表
对用户来说，分区表是一个独立的逻辑表，但是底层是有多个物理子表组成。实现分区的代码实际上是对一组底层表的句柄对象
（handler object）的封装。  
分区的一个主要目的是将数据按照一个较粗的粒度分布在不同的表中。
### 7.2 视图
### 7.3 外键约束
### 7.4 游标
### 7.5 绑定变量
### 7.6 用户自定义函数
### 7.7 插件
### 7.8 字符集和校对
### 7.9 全文检索
### 7.10 分布式（XA）事务
### 7.11 查询缓存

## 第8章 优化服务器设置
### 8.1 MySQL配置的工作原理
### 8.2 什么不该做
### 8.3 创建MySQL配置文件
### 8.4 配置内存使用
### 8.5 配置MySQL的IO行为
### 8.6 配置MySQL并发
### 8.7 基于工作负载的配置
### 8.8 完成基本配置
### 8.9 安全和稳定的设置
### 8.10 高级InnoDB设置

## 第9章 操纵系统和硬件优化
### 9.1 什么限制了MySQL的性能
CPU、I/O
### 9.2 如何为MySQL选择CPU
### 9.3 平衡内存和磁盘资源
### 9.4 固态存储
### 9.5 为备库选择硬件
### 9.6 RAID性能优化
### 9.7 SAN和NAS
### 9.8 使用多磁盘卷
### 9.9 网络配置
### 9.10 选择操作系统
### 9.11 选择文件系统
### 9.12 选择磁盘阵列调度策略
### 9.13 线程
### 9.14 内存交换区
### 9.15 操作系统状态

## 第10章 复制
复制功能不仅有利于构建高性能的应用，同时也是高可用性、可扩展性、灾难恢复、备份以及数据仓库等工作的基础。
### 10.1 复制的概述
#### 10.1.1 复制解决的问题
* 数据分布
* 负载均衡
* 备份
* 高可用性和故障切换
* MySQL升级测试
  
#### 10.1.2 复制如何工作
1. 在主库上把数据更改记录到二进制日志（binary log）中（这些记录被称为二进制日志事件）
2. 备库将主库上的日志复制到自己的中继日志（relay log）中。备库IO线程，跟主库连接，主库二进制转储线程
3. 备库读取中继日志中的事件，将其重放到备库数据之上

### 10.2 配置复制
### 10.3 复制的原理
### 10.4 复制拓扑
### 10.5 复制的容量规划
### 10.6 复制管理和维护
### 10.7 复制有多快
### 10.8 MySQL复制的高级特性
### 10.9 其他复制技术

## 第11章 可扩展的MySQL
### 11.1 什么是可扩展性
可扩展性表明了当需要增加资源以执行更多工作时，系统能够获得划算的等同提升的能力。   
系统容量表示在一定时间内能够完成的工作量，但容量必须是可以有效的利用。系统的最大吞吐量并不等同于容量。  
容量和可扩展性并不依赖于性能。从较高层次看，可扩展性就是能够通过增加资源来提升容量的能力。  
#### 11.1.1 正式的可扩展性定义
可扩展性是当增加资源以处理负载和增加容量事系统能够获得的投资产出率（ROI）。  
通用可扩展性定律（Universal Scalability Law，USL）线性扩展的偏差的两个因素：
* 无法并行执行的一部分工作  Amdahl定律，导致吞吐量趋于平缓。如果部分任务无法并行，那么不管如何分而治之，该任务至少需要串行的那部分时间。
* 需要交互的另外一部分工作  内部节点间或进程间通信，通信信道的数量 

### 11.2 扩展MySQL
#### 11.2.1 规划可扩展性
#### 11.2.2 为扩展赢得时间
准备工作：
1. 优化性能
2. 购买性能更强的硬件

#### 11.2.3 向上扩展
向上扩展，垂直扩展，意味着购买更多性能强悍的硬件。如0.5TB内存、32核CPU、强悍I/O性能（如PCIe卡的flash存储）
#### 11.2.4 向外扩展
向外扩展(横向扩展，水平扩展)策略划分为三个部分：复制、拆分、数据分片
1. 按功能拆分 按功能拆分，或者说职责吃啊饭，意味着不同的节点执行不同的任务。
2. 数据分片
3. 选择分区键
4. 多个分区键
5. 跨分片查询
6. 分配数据、分片和节点
7. 在节点上部署分片
8. 固定分配
9. 动态分配
10. 混合动态分配和固定分配
11. 显示分配
12. 重新均衡分片数据
13. 生车全局唯一ID
14. 分片工具

### 11.3 负载均衡
负载均衡的目的：
1. 可扩展性
2. 高效性
3. 可用性
4. 透明性
5. 一致性 

> PS：dubbo负载均衡
#### 11.3.1 直接连接
#### 11.3.2 引入中间件
应用服务器 --> 负载均衡器（如HAProxy） --> 数据库服务器   
1. 负载均衡器
2. 负载均衡算法
   * 随机
   * 轮询
   * 最少连接数
   * 最快响应
   * 哈希 源IP地址哈希
   * 权重 结合使用上述算法
3. 在服务器池中增加/移除服务器

#### 11.3.3 一主多备间的负载均衡

## 第12章 高可用性
### 12.1 什么是高可用行
### 12.2 导致宕机的原因
* 运行环境问题上，磁盘空间耗尽
* 性能问题上，糟糕的SQL
* 槽糕的schema和索引设计
* 复制问题通常由于主备数据不一致导致
* 数据丢失问题通常由于drop table的误操作导致

### 12.3 如何实现高可用性
#### 12.3.1 提升平均失效时间（MTBF）
#### 12.3.2 降低平均恢复时间（MTTR）
### 12.4 避免单点失效
### 12.5 故障转移和故障恢复
故障转移（failover），回退（failback），切换（switchover）  
> PS：dubbo集群策略
#### 12.5.1 提升备库或切换角色
#### 12.5.2 虚拟IP地址或IP接管
#### 12.5.3 中间件解决方案
#### 12.5.4 在应用中处理故障转移 

## 第13章 云端的MySQL
### 13.1 云的优点、缺点和相关误解
### 13.2 MySQL在云端的经济价值
### 13.3 云中的MySQL的可扩展性和高可用性
### 13.4 四种基础资源
CPU周期、内存、I/O、网络
### 13.5 MySQL在云主机上的性能
### 13.6 MySQL数据库即服务（DBaaS）

## 第14章 应用层优化
### 14.1 常见问题
### 14.2 Web服务器问题
### 14.3 缓存
#### 14.3.1 应用层以下的缓存
#### 14.3.2 应用层缓存
应用层缓存通常在**同一台机器的内存**中的存储数据，或者通过网络存储在**另一台机器的内存**中。
* 本地缓存
* 本地共享内存缓存
* 分布式内存缓存
* 磁盘上的缓存

#### 14.3.3 缓存控制策略
* TTL time to live 存活时间
* 显示失效 更新时失效，写--失效、写--更新
* 读时失效

#### 14.3.4 缓存对象分层
#### 14.3.5 预生成内容
#### 14.3.6 作为基础组件的缓存
#### 14.3.7 使用HandlerSocket和memcached
### 14.4 扩展MySQL
### 14.5 MySQL的替代品
* 文件存储、图像存储 MySQL blob vs 文件系统
* 全文检索 mysql vs luncene和sphinx
* 键值存储 mysql vs redis
* 结构化数据 mysql vs hadoop

## 第15章 备份与恢复
### 15.1 为什么要备份
### 15.2 定义恢复需求
### 15.3 设计MySQL备份方案
### 15.4 管理和备份二进制日志
### 15.5 备份数据 
### 15.6 从备份中恢复
### 15.7 备份和恢复工具
### 15.8 备份脚本化

## 第16章 MySQL用户工具
### 16.1 接口工具
mysql workbench、SQLyong、phpMyAdmin、Adminer
### 16.2 命令行工具集
mysqladmin、mysqlcheck。
### 16.3 sql使用集
### 16.4 检测工具
* 健康监测工具，监测到异常时告警
* 为趋势、诊断、问题排查、容量规划等记录指标的工具
  
#### 16.4.1 开源的监控工具
* nagios 问题监测和告警系统
* zabbix 同时支持监控和指标收集的完整系统
* zenoss python编写，基于浏览器的用户界面
* hyeric HQ 基于java
* groundwork open source

专注于收集指标和画图以及可视化，而不是性能监控检查
* MRTG Multi Router Traffic Grapher
* Cacti
* Granglia
* Munin

#### 16.4.2 商业监控系统
#### 16.4.3 Innotop的命令行监控


