《大型网站技术架构 核心原理与案例分析》 李智慧

* 分层、分割、分布式 集群、缓存、异步 冗余、自动化、安全
* 高性能、高可用、高可靠、可伸缩、可扩展、安全

# 第1篇 概述
## 第1章 大型网站架构演化
## 第2章 大型网站架构模式
> 每一个模式描述了一个在我们周围不断重复发送的问题及该问题解决方案的核心。这样，你就能一次又一次地使用该方案而不必做重复的工作。 ----建筑学

### 2.1 网站架构模式
* 分层 横向切分、水平域
* 分割 纵向切分、垂直域
* 分布式 不同模块部署到不同的服务器上，通过**远程调用**协同工作。
* 集群 多台服务器部署相同应用构成一个集群，通过负载均衡设备共同对外提供服务。提高系统的可用性。
* 缓存 将数据存放在距离计算最近的位置以加快处理速度。CDN、反向代理缓存、本地缓存、分布式缓存
* 异步 解耦合。分布式消息队列。
* 冗余
* 自动化
* 安全

### 2.2 
被分层和分割后的业务模块与基础技术模块**分布式**部署，每个模块都部署在一组独立的服务器**集群**上，通过远程调用的方式进行依赖访问。

## 第3章 大型网站核心架构要素
> 有关软件整体结构与组件的抽象描述，用于指导大型软件系统各个方面的设计。 ---- 维基百科 软件架构

### 3.1 性能
网站性能指标，有响应时间、TPS、系统性能计数器。
### 3.2 可用性
高可用设计的目标就是当服务器宕机的时候，服务或者应用依然可用。
高可用的手段是冗余，部署多台服务器，互相备份。
### 3.3 伸缩性
通过不断向集群中加入服务器的手段来缓解不断上升的用户并发访问压力和不断增长的数据存储需求。
### 3.4 可扩展性
不同于其他架构要素主要关注非功能需求，网站的可扩展性直接关注网站的功能需求。
主要手段：事件驱动架构（消息队列实现）、分布式服务（服务框架）、网站服务（第三方应用）。
### 3.5 安全

# 第2篇 架构
## 第4章 高性能架构
网站性能是客观的指标，可以具体体现到响应时间、吞吐量等技术指标，同时也是主管的感受。
### 4.1 网站性能测试
性能测试是性能优化的前提和基础，也是性能优化结果的检查和度量标准。
#### 4.1.1 不同视角下的网站性能
1. 用户视角下的网站性能
2. 开发人员视角的网站性能
3. 运维人员视角的网站性能 关注基础设施性能和资源利用率

#### 4.1.2 性能测试指标
1. 响应时间 指应用执行一个操作需要的时间，包括从发出请求开始到最后收到响应数据所需要的时间
2. 并发数 指系统能够同时处理请求的数量，反映了系统的负载特性
3. 吞吐量 单位时间内处理请求数量，体现系统的整体处理能力
4. 性能计数器 SystemLoad、对象与线程数、内存使用、CPU使用、磁盘与网络IO

#### 4.1.3 性能测试方法
1. 性能测试
2. 负载测试
3. 压力测试
4. 稳定性测试

#### 4.1.4 性能测试报告
#### 4.1.5 性能优化策略

### 4.2 Web前端性能优化
1. 浏览器优化访问 减少http请求、使用浏览器缓存、启用压缩、css放在页面上面、javascript放在页面最下面、减少cookie传输
2. CDN加速 本质仍然是一个缓存，而且将数据缓存再离用户最近的地方。部署在网络运营商的机房。**最短路径**返回响应。
3. 反向代理 位于网站机房一侧，代理网站Web服务器接受HTTP请求。代理设置缓存，实现负载均衡。

### 4.3 应用服务器性能优化
优化手段主要有缓存、集群、异步等。
1. 分布式缓存
2. 异步操作 消息队列异步写库
3. 使用集群
4. 代码优化
   * 多线程 使用多线程原因：IO阻塞与多核CPU
     * 将对象设计成无状态对象、使用局部对象、并发访问使用锁
   * 资源复用 开销很大的系统资源，数据库连接、网络通信连接、线程、复杂对象；资源复用的两种模式：单例、对象池
   * 数据结构
   * 垃圾回收
   
### 4.4 存储性能优化
很多时候，磁盘仍然是系统最严重的瓶颈。
1. 机械硬盘 vs 固态硬盘
2. B+树 vs LSM树
3. RAID vs HDFS

## 第5章 高可用架构
### 5.1 网站可用性的度量与考核
### 5.2 高可用的网站架构
### 5.3 高可用的应用
利用负载均衡进行无状态服务的失效转移
应用服务器集群的session管理
### 5.4 高可用的服务
分级管理、超时设置、异步调用、服务降级、幂等设计
### 5.5 高可用的数据
cap原理、BASE、数据备份、失效转移
### 5.6 高可用网站的软件质量保证
1. 网站发布
2. 自动化测试
3. 预发布验证
4. 代码控制
5. 自动化发布
6. 灰度发布

### 5.7 网站运行监控
1. 监控数据采集 
   1. 用户行为日志收集（服务器端、客户端浏览器）
   2. 服务器性能监控（load、内存、磁盘io、网络io）
   3. 运行数据报告 缓存命中率、平均响应延迟时间
2. 监控管理
   1. 系统报警
   2. 失效转移
   3. 自动优雅降级

## 第6章 伸缩性架构
网站的伸缩性是指不需要改变网站的软硬件设计，仅仅通过改变部署的服务器数据就可以扩大或者缩小网站的服务处理能力。

### 6.1 网站架构的可伸缩性设计
不同功能进行**物理分离**实现伸缩
单一功能通过**集群规模**实现伸缩

### 6.2 应用服务器集群的伸缩性设计
* 负载均衡层次：http重定向、dns域名解析、反向代理、ip、数据链路层（修改mac地址）
* 负载均衡算法：轮询、加权轮询、随机、**最小连接**、**源地址散列**；PS：dubbo的负载均衡

### 6.3 分布式缓存集群的伸缩性设计
分布式缓存的一致性hash算法
### 6.4 数据存储服务器集群的伸缩性设计

## 第7章 可扩展架构
* 可扩展性 指对现有系统影响最小的情况下，系统功能可持续扩展或提升的能力。减少依赖和耦合，对需求变更可以敏捷响应，是系统架构设计层面的**开闭原则**
* 伸缩性 指系统能够通过增加（减少）自身资源规模的方式增强（减少）自己计算处理事务的能力。如果成比例的，称作线性伸缩性。

### 7.1 构建可扩展的网站架构
设计网站可扩展架构的核心思想是模块化，并在此基础之上，降低模块间的耦合性，提高模块的复用性。

模块化分布式不受以后具体聚合方式主要有**分布式消息队列**和**分布式服务**。

### 7.2 利用分布式消息队列降低系统耦合性
事件驱动架构

分布式消息队列
### 7.3 利用分布式服务打造可复用的业务平台
使用分布式服务是降低系统耦合性的另一个重要手段，不同子系统通过相同的接口描述进行服务调用。
### 7.4 可扩展的数据结构
NoSQL数据库使用的ColumnFamily设计，面向列族的稀疏矩阵存储格式。
### 7.5 利用开发平台建设网站生态圈
大型网站为了开发更多的增值服务，会把网站内部的服务封装成一些调用接口开放出去，供外部的第三方开发者使用。
网站、用户、第三方开发者互相依赖，形成一个网站的生态圈。

## 第8章 安全架构
### 8.1 应用攻击
1. XSS攻击（Cross Site Script） 篡改网页，注入html脚本
2. 注入攻击 sql注入、os注入
3. CSRF攻击（Cross Site Request Forget，跨站请求伪造） 防御手段主要是识别请求者的身份，如表单Token、验证码、Refeer check
4. ErrorCode、html注释、文件上传、路径遍历
5. Web应用防火墙
6. 网站安全漏洞扫描

### 8.2 信息加密技术及密钥安全管理
1. 单向散列算法
2. 对称加密
3. 非对称加密
4. 密钥安全管理

### 8.3 信息过滤与反垃圾
文本匹配、分类算法、黑名单
### 8.4 电子商务风险控制
1. 风险
2. 风控

# 第3篇 案例
## 第9章 淘宝网的架构演化案例分析
## 第10章 维基百科的高性能架构设计分析
## 第11章 海量分布式存储系统Doris的高可用架构师设计分析
## 第12章 网站秒杀系统架构设计案例分析
### 12.2 秒杀系统的应对策略
1. 秒杀系统独立部署
2. 秒杀商品页面静态化
3. 租借秒杀活动网络带宽
4. 动态生成随机下单页面URL

### 12.3 秒杀系统的架构设计
## 第13章 大型网站典型故障案例分析
遇到问题，解决问题，经历了这个过程，技术才能升华，人和技术才能融为一体，才知道什么技术是真正有用的。

# 第4篇 架构师
## 第14章 架构师领导艺术
### 14.1 关注人而不是关注产品
一群优秀的人做一件他们热爱的事情，一定能取得成功。
### 14.2 发掘人的优秀
是事情成就了人，而不是人成就了事。
### 14.3 共享美好蓝图
### 14.4 共同参与架构
### 14.5 学会妥协
不要企图在项目中证明自己是正确的，一定要记住，你是来做软件的，而不是来当老大的。
### 14.6 成就他人
我们活着不是为了工作，不是为了做设计、写程序，这些不是我们生活的目的。
我们活着是为了成就我们自己，而要想成就我们自己，就必须首先成就他人。

每个人都有自己成就的目标，而工作是达成自我成就的一种手段：通过工作的挑战，发掘自我的潜能，重新认知自我和世界。

## 第15章 网站架构师职场攻略
### 15.1 发现问题，寻找突破
### 15.2 提出问题，寻求支持
### 15.3 解决问题，达成绩效

## 第16章 漫话网站架构师

# 附录A 大型网站架构技术一览
1. 前端架构 浏览器架构、CDN、动静分离、图片服务器、反向代理、DNS
2. 应用层架构 开发框架、页面渲染、负载均衡、Session管理、动态页面静态化、业务拆分、虚拟化服务器
3. 服务层架构 分布式消息、分布式服务、分布式缓存、分布式配置
4. 存储层架构 分布式文件、关系数据库、NoSQL数据库、数据同步
5. 后台架构 搜索引擎、数据仓库、推荐系统
6. 数据采集与监控 浏览器数据采集、服务器业务数据采集、服务器性能数据采集、系统监控、系统报警
7. 安全架构 Web攻击、数据保护
8. 数据中心机房架构 机房架构、机柜架构、服务器架构