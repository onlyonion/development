《大型分布式网站架构设计与实践》陈康贤

1. 面向服务的体系结构 soa 服务框架
2. 分布式系统基础设施 缓存、存储、消息、搜索引擎
3. 互联网安全架构 加密算法、摘要、签名
4. 系统稳定性 日志分析、集群监控、流量控制、性能优化、故障排查
5. 数据分析 日志收集、离线分析、流式分析、数据同步、数据报表

## 第1章 面向服务的体系结构（SOA）
### 1.1 基于TCP协议的RPC
### 1.2 基于HTTP协议的RPC
### 1.3 服务的路由和负载均衡
SOA架构中，通服务名称找到要调用的服务的地址列表，称为服务的路由。
#### 1.3.2 负载均衡算法
1. 轮询算法
2. 随机
3. 源地址哈希
4. 加权轮询
5. 加权随机

#### 1.3.3 动态规则配置
#### 1.3.7 路由和负载均衡算法的实现
### 1.4 HTTP服务网关

## 第2章 分布式系统基础设施
### 2.1 分布式缓存
#### 2.1.3 分布式session
### 2.2 持久化存储
#### 2.2.1 MySQL扩展
1. 业务拆分
2. 复制策略
3. 分表与分库

#### 2.2.2 HBase
本质上是一张稀疏的大表，用来存储粗粒度的结构化数据，并且能够通过简单地增加节点来实现系统的线性扩展。
HBase每个列属于一个特定的列表，通过行和列来确定一个存储单元，而每个存储单元又可以有多个办吧，通过时间戳来标示。

HBase集群中包含两种角色，HMaster和HRegionServer。
当表随着记录条数的增加而不断变大后，将会分裂成一个个Region，每个Region可以又（startkey，endkey）来表示，它包含一个startkey和endkey的半闭区间。

一个HRegionServer可以管理多个Region，并由HMaster来辅助HRegionServer的调度级集群桩体的监管。
由于Region可以分散并由不同的HRegionServer来管理，因此，理论上再大的表都可以通过集群来处理。

#### 2.2.3 Redis

### 2.3 消息系统
异步、解耦、削峰填谷
- JMS
  - P2P点对点 基于队列queue
  - Pub/Sub发布订阅 基于主题topic
- ActiveMQ

### 2.4 垂直化搜索引擎
#### 2.4.1 Lucene简介
- 倒排索引 文档的词为关键词，建立词与文档的映射关系，根据词快速获取包含这个词的文档列表
- 分词、切词 将句子或者段落进行切割，从中提取出包含固定语义的词。
- 停止词
- 排序 相关的更大的靠前，排序算法
- 文档Document 一系列域的集合
- 域Field
- 词Term
- 查询Query 一系列Term的条件组合
- 分词器

#### 2.4.2 Lucene的使用
1. 构建索引
2. 索引更新域删除 IndexWriter
3. 条件查询
4. 结果排序
5. 高亮
6. 中文分词
7. 索引优化 Lucene的索引是由段segment组成的，每个段可以包含多个索引文件。每个段包含一个或多个Document。
   索引段合并，减少进程打开的文件句柄数量。
8. 分布式扩展 对请求进行Hash，均匀分发到集群中的每台机器

专门的集群来生成索引，并且生成索引的集群不复杂处理前台的查询请求。
增量更新请求将不断地发给查询服务器。每个一定周期对索引继续一次全量的重建操作。

面临高并发的用户访问，又需要对海量的数据集进行索引，既采用**索引读写分离**的方式，以支撑更大的并发访问量，
又要采用**索引分片**的方式，以解决数据量膨胀导致的存储压力以及索引性能下降的问题。

#### 2.4.3 Solr
Solor是一个基于Lucene、功能强大的搜索引擎工具。
- 提供一系列HTTP操作接口，支持通过DataSchema来定义字段、类型和设置文本分析，使得用户可以通过HTTP POST请求，向服务器提交Document，生成索引，以及索引的更新和删除操作。
- 提供表达式查询语言，进行复杂查询。
- 提供可配置能力，后台管理系统。

### 2.5 其他基础设施
实时计算、离线计算、分布式文件系统、日志收集系统、监控系统、数据仓库、
CDN系统、负载均衡系统、消息推送系统、自动化运维

## 第3章 互联网安全架构
### 3.1 常见的Web攻击手段
* XSS攻击 跨站脚本攻击 HTTP代码转义
* CRSF攻击 跨站请求伪造 将cookie设置HttpOnly、增加token、通过Referer识别
* SQL注入攻击 使用预编译语句、使用ORM框架
* 文件上传漏洞
* DDoS攻击
  * SYN Flood，TCP Flood 服务端维护半连接等待列表，耗尽资源
  * DNS Query Flood，UDP Flood 发送海量域名解析请求（随机生成的、不存在的），DNS服务器本地缓存没有，向上层DNS服务器递归请求
  * CC攻击Challenge Collapsar属于DDoS的一种，HTTP Flood，控制大量匿名HTTP代理
* 其他攻击手段

### 3.2 常用的安全算法
#### 3.2.1 数字摘要
MD5、SHA、十六进制编码、Base64编码、彩虹表破解Hash算法
#### 3.2.2 对称加密算法
DES、AES
#### 3.2.3 非对称加密算法
RSA
#### 3.2.4 数字签名
非对称加密算法与数字摘要技术的综合运用，指的是将通信内容的**摘要信息**使用**发送者的私钥**进行加密，
然后将密文与原文一起传输给信息的接收者，接收者通过**发送者的公钥进行解密**被加密的摘要信息，
然后使用与发送者相同的摘要算法，对接收到的内容采用相同的方式产生摘要串，与解密的摘要串对比。
#### 3.2.5 数字证书

### 3.3 摘要认证
* 为什么需要认证
* 摘要认证的原理
* 摘要认证的实现

### 3.4 签名认证
* 签名认证的原理
* 签名认证的实现

### 3.5 HTTPS协议
* HTTPS协议的原理
* SSL/TLS
* 部署HTTPS Web

### 3.6 OAuth协议
* OAuth
* OAuth授权过程

## 第4章 系统稳定性
### 4.1 在线日志分析
### 4.2 集群监控
#### 4.2.1 监控指标
* load `top`, `uptime`
* cpu利用率 `top | grep Cpu`
* 磁盘剩余空间 `df -h` 查看剩余空间
* 网络traffic `sar -h DEV 1 1` 查看网络状态
* 磁盘I/O `iostat -d -k`
* 内存使用 `free -m`
* qps
* rt response time 请求响应时间
* select/ps 每秒处理select语句的数量
* update/ps, delete/ps
* GC Young(Eden, Suvivor From To, Tenure, Permante)

#### 4.2.2 心跳检测
1. ping
2. 应用层检查 curl
3. 业务检测

#### 4.2.3 容量评估及应用水位

### 4.3 流量监控
#### 4.3.1 流量控制实施
* 超出流量直接丢弃
* 基于Java的信号量机制Semaphore
* 通过单机内存队列进行有限的等待
* 分布式消息将请求异步化
    削峰填谷

#### 4.3.2 服务稳定性
* 依赖管理
* 优雅降级
* 服务分级
* 开关
* 应急预案
  * 明确服级别、梳理核心应用调用链路
  * 低级别的调用实现准备好开关和接口
  * 优先级-丢车保帅

#### 4.3.3 高并发系统设计
保证系统的**可用性**和可扩展性，又要兼容数据的**一致性**，处理多线程**同步**问题
* 操作原子性 Java原子操作、数据原子操作
* 多线程同步 协同步调，按照预定的次序来执行 synchronized、volatile、lock
* 数据一致性 CAP、BASE 强一致性、弱一致性、最终一致性，分库分表
* 系统可扩展性
* 并发减库存 验证码防刷、数据一致性、多条件更新库存、库存单条记录拆分多条记录

### 4.4 性能优化
#### 4.4.1 如何寻找性能瓶颈
* 前端优化工具-YSlow
* 页面响应时间 firebug
* 方法响应时间 btrace
* GC日志分析
* 数据库查询 `log_slow_qqueries long_query_time`
* 系统资源使用

#### 4.4.2 性能测试工具
* ApacheBench
* ApacheJMeter
* HP LoadRunner
* 反向代理引流
* TCPCopy

#### 4.4.3 性能优化措施
* 前端性能优化
* Java程序优化
  * 单例
  * Future模式
  * 线程池
  * 选择就绪
  * 减少上下文切换
  * 降低锁竞争
* 压缩
* 结果缓存
* 数据库查询性能优化
  * 合理使用索引 独立的列（表达式、函数不走索引），模糊查询
  * 反范式设计
  * 使用查询缓存
  * 使用搜索引擎
  * 使用key-value数据库
* GC优化
* 硬件提升性能

### 4.5 Java引用故障的排查
#### 4.5.1 常用的工具
* jps, jstat, jinfo, 
* jstack, jmap(-heap, -dump, -permstat)
* BTrace, 
* jconsole, eclipse mat, visualvm

#### 4.5.2 典型案例分析
##### 内存溢出
##### 线程死锁或信号量没释放
##### 类加载冲突
NoClassDefFoundError, NoSuchMethodError

## 第5章 数据分析
### 5.1 日志收集
### 5.2 离线数据分析
### 5.3 流式数据分析
### 5.4 数据同步
### 5.5 数据报表