《Redis设计与实现》 黄建宏

* 数据结构与对象 简单动态字符串、链表、字典、跳跃表、整数集合、压缩列表、对象
* 单机数据库的实现 RDB、AOF、事件、客户端、服务端
* 多机数据库的实现 复制、sentinel、集群
* 独立功能的实现 发布订阅、事务、Lua脚本、排序、二进制位数组、慢查询日志、监视器

## 第1章 引言

# 第一部分 数据结构与对象
* 底层实现数据结构
* Redis的对象处理机制以及数据库的实现原理

## 第2章 简单动态字符串
Simple Dynamic String，简单动态字符串 
```c++
// sds.h/sdshdr
struct sdshdr {
    // 记录buff数组中已使用字节的数量，等于SDS所保存字符串的长度
    int len;
    // 记录buf数组中未使用字节的数量
    int free;
    char buf[];
}
```

## 第3章 链表
### 3.3 重点回顾
* 每个链表节点由一个listNode结构来表示，每个节点都有一个指向前置节点和后置节点的指针，双端链表
* 每个链表使用一个list结构来表示，这个结构带有表头节点指针、表尾节点指针，以及链表长度等信息。

## 第4章 字典
字典，又称为符号表、关联数组或映射，是一种用于保存键值对的抽象数据结构。
### 4.1 字典的实现
### 4.2 哈希算法
### 4.3 解决键冲突
使用链地址法解决键冲突，每个哈希表节点都有一个next指针，多个哈希表节点可以用next指针构成一个**单向链表**，被分配到
同一个索引上的多个节点可以用这个单向链表连接起来。
### 4.4 rehash
键值对逐渐增多或者减少，为了让负载因子维持一个合理的范围之内，当哈希表保存的键值对数量太多或者太少时，需要对哈希表
进行相应的扩展或者收缩。

### 4.5 渐进式rehash
### 4.6 字典API

## 第5章 跳跃表
skiplist是一种有序数据结构，通过在每个节点中维持多个指向其他节点的指针，从而达到快速访问节点的目标。
有序集合键的底层实现之一。

Redis中两个地方用了跳跃表，实现有序集合键，集群节点中用作内部数据结构。

## 第6章 整数集合
intset是集合键的底层实现之一。当一个集合只包含整数值元素，并且这个集合的元素数量不多时。

## 第7章 压缩列表
ziplist是列表键合哈希键的底层实现之一。

### 7.1 压缩列表的构成
压缩列表是Redis为了节约内存而开发的，是由一系列特殊编码的**连续内存块**组成的**顺序型**数据结构。一个压缩列表可以包含任意
多个节点，每个节点可以保存一个字节数组或者一个整数值。

## 第8章 对象
Redis并没有直接使用这些数据结构，而是基于这些数据结构创建了一个对象系统，这个系统包含字符串对象、列表对象、哈希对象、
集合对象和有序集合对象。

Redis使用对象来表示数据库中的键和值。当在Redis新建一个键值对时，至少会创建两个对象，
一个对象用来做键值对的键，另一个对象用来做键值对的值。
```
typeof struct redisObject {
    unsigned type:4; // 类型
    unsigned ecoding:4; // 编码
    void *ptr; // 指向底层实现数据结构的指针
}
```

* 字符串对象 字符串对象的编码可以是int、raw或者embstr
* 列表对象 列表对象的编码可以是ziplist或者linkedlist
* 哈希对象 哈希对象的编码可以是ziplist或者hashtalbe
* 集合对象 集合对象的编码可以是intset或者hashtable
* 有序集合对象 有序集合的编码可以是ziplist或者skiplist

Redis的对象系统实现了基于引用计数的内存回收机制。通过引用计数实现了对象的共享机制。

# 第二部分 单机数据库的实现
## 第9章 数据库
### 9.5 过期键删除策略
- 定时删除 timer定时，键过期时删除。大量定时器耗CPU、查找Key不易（无序链表）
- 惰性删除 使用时判断删除。对内存不友好
- 定期删除 每隔一段时间，删除过期key

### 9.6 Redis的过期键删除策略
### 9.7 AOF、RDB和复制功能对过期键的处理
- 生成RDB 过滤过期的
- 载入RDB 主服务器时，过滤过期的；从服务器时，保存所有
- AOF文件写入 过期但是没有被惰性删除或定期删除，不受影响；删除之后追加del命令
- AOF重写 过滤过期的
- 复制 从服务器的删除动作由主服务器决定

## 第10章 RDB持久化
### 10.5 
* save 服务器进程执行保存操作，会阻塞服务
* bgsave 子进程执行保存操作，不会阻塞

## 第11章 AOF持久化
### 11.4
* aof 
* AOF重写 产生一个新的AOF文件，体积更小

## 第12章 事件
Redis服务器是一个事件驱动的程序，服务器需要处理一下两类事件
- 文件事件
- 时间事件

### 12.1 文件事件
Redis基于Reactor模式开发了自己的网络事件处理器
- 文件事件处理器使用了IO多路复用程序来同时监听多个套接字，并根据套接字目前执行的任务来为套接字关联不同的事件处理器
- 当被监听的套接字准备好执行连接应答（accept）、读取（read）、写入（write）、关闭（close）等操作，
与操作相对应的文件事件就会产生，这时文件事件处理器就会调用套接字之前关联的事件处理器来处理这些事件。

#### 12.1.1 文件事件处理器的构成
套接字、IO多路复用程序、文件事件分派器、事件处理器

#### 12.1.2 IO多路复用程序的实现
Redis的IO多路复用程序的所有功能都是通过包装常见的select、epoll、evport和kqueue这些IO多路复用函数库来实现的，
每个IO多路复用函数在Redis源码中都对应一个单独的文件，比如ae_select.c、ae_epoll.c、ae_kequeue.c。

- IO多路复用
  - select
  - epoll
  - evport
  - kqueue

#### 12.1.3 事件的类型
AE_READABLE AE_WRITEABLE
#### 12.1.4 API

### 12.2 时间事件
### 12.3 事件的调度与执行
### 12.4 重点回顾
* Redis服务器是一个事件驱动程序，时间事件、文件事件
* 文件事件处理器是基于Reactor模式实现的网络通信程序
  - 对套接字操作的抽象，每次套接字变为可应答（acceptable）、可写、可读时，相应的事件就会产生 
  - AE_READBlE读事件、AE_WRITABLE写事件
* 时间事件可分为定时事件（指定时间）和周期性事件（每隔一段时间）。

## 第13章 客户端
## 第14章 服务器
### 14.4
* 一个命令请求
  1. 客户端将命令请求发送到服务器
  2. 服务器读取命令请求，并分析出命令参数
  3. 命令执行器根据参数查找命令的实现函数，然后执行实现函数并得出命令回复
  4. 服务器将命令回复返回给客户端 
* serverCron函数默认每隔100毫秒执行一次，它的主要工作包括更新服务器状态、处理服务器接受的sigterm信号，
  管理客户端资源和数据库连接，检查并执行持久化操作
* 服务器启动到处理客户端命令
  1. 初始化服务器状态
  2. 载入服务器配置
  3. 初始化服务器数据结构
  4. 还原数据库状态
  5. 执行事件循环 

# 第三部分 多机数据库的实现
## 第15章 复制
在Redis中，用户可以通过执行slaveof命令或者设置slaveof选项，让一个服务器去复制另一个服务器，我们称呼被复制
的服务器为主服务器，而对主服务器进行复制的服务器则被称为从服务器。

为了解决旧版复制功能在处理断线重复制情况时的低效问题，Redis从2.8版本开始使用`psync`命名代替`sync`命令来执行复制时的同步操作。

### 15.6 复制的实现
```sh
# slaveof <master_ip> <master_port>  
slaveof 127.0.0.1 6379
```

1. 设置主服务器的地址和端口
2. 建立套接字连接
3. 发送ping命令 从服务器成为主服务器的客户端之后，从服务器向主服务器发送ping命令
4. 身份验证
5. 发送端口信息
6. 同步
7. 命令传播 主服务器执行的写命令发送给从服务器

## 第16章 Sentinel
Sentinel（哨兵）是Redis的**高可用性**解决方案：由一个或多个Sentinel实例组成的Sentinel系统可以监视任意多个主服务器，
以及这些主服务器属下的所有从服务器，并在被监视的主服务器进入下线状态时，
自动将下线的主服务器属下的某个从服务器升级为新的主服务器，然后由新的主服务器代替已下线的主服务器继续处理命令请求。

* 获取主服务器信息
* 获取从服务器信息
* 向主服务器和从服务器发送信息
* 故障转移

## 第17章 集群
Redis集群，提供分布式数据库方案，集群通过**切片**来进行数据库共享，并提供复制和故障转移功能。

* 节点
* 槽指派
* 在集群中执行命令
* 重新分片
* 复制与故障转移
* 消息 集群中各节点通过发送和接收消息来进行通信

# 第四部分 独立功能的实现
## 第18章 发布与订阅
Redis的发布与订阅功能由publish、subscribe、psubscribe等命令组成。
## 第19章 事务
Redis通过multi、exec、watch等命令来实现事务功能。
事务提供了将多个命令请求打包，然后一次性、按顺序执行多个命令的机制，并且在事务执行期间，
服务器不会中断事务而改去执行其他客户端的命令请求。
## 第20章 Lua脚本
## 第21章 排序
Redis的sort命令可以对列表键、集合键或者有序集合键的值进行排序。
```sh
sort <key>
```
## 第22章 二进制位数组
## 第23章 慢查询日志
## 第24章 监视器